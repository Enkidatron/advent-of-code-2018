module Day13 exposing (Cart, CartDecision(..), CartMovementResult(..), Direction(..), State, Track, TrackSegment(..), cartToCoords, charToCart, charToTrackSegment, compareCarts, exampleText, exampleText2, findFirstCrash, findLastCart, getTrackSegment, incrementCart, inputText, moveCartsRecursively, moveCartsSafelyRecursively, parseCarts, parseCartsLine, parseState, parseTrack, parseTrackLine, part1, part2)

import Array exposing (Array)
import List.Extra


type alias Track =
    Array (Array TrackSegment)


type TrackSegment
    = Straight
    | CornerDownLeftToUpRight
    | CornerUpLeftToDownRight
    | Intersection
    | EmptySpace


type CartDecision
    = LeftNext
    | StraightNext
    | RightNext


type Direction
    = Up
    | Down
    | Right
    | Left


type alias Cart =
    { x : Int
    , y : Int
    , facing : Direction
    , nextDecision : CartDecision
    }


type alias State =
    { track : Track
    , carts : List Cart
    }


parseState text =
    { track = parseTrack text
    , carts = parseCarts text
    }


parseTrack text =
    text
        |> String.lines
        |> List.map parseTrackLine
        |> Array.fromList


parseTrackLine line =
    String.toList line
        |> List.map charToTrackSegment
        |> Array.fromList


charToTrackSegment char =
    case char of
        ' ' ->
            EmptySpace

        '>' ->
            Straight

        '<' ->
            Straight

        'v' ->
            Straight

        '^' ->
            Straight

        '-' ->
            Straight

        '|' ->
            Straight

        '/' ->
            CornerDownLeftToUpRight

        '\\' ->
            CornerUpLeftToDownRight

        '}' ->
            CornerUpLeftToDownRight

        '+' ->
            Intersection

        _ ->
            Debug.todo "unexpected track character in track"


parseCarts text =
    text
        |> String.lines
        |> List.indexedMap parseCartsLine
        |> List.concat


parseCartsLine y line =
    String.toList line
        |> List.indexedMap (charToCart y)
        |> List.filterMap identity


charToCart y x char =
    case char of
        '>' ->
            Just <| Cart x y Right LeftNext

        '<' ->
            Just <| Cart x y Left LeftNext

        'v' ->
            Just <| Cart x y Down LeftNext

        '^' ->
            Just <| Cart x y Up LeftNext

        _ ->
            Nothing


findFirstCrash state =
    let
        movementResult =
            state.carts
                |> List.sortWith compareCarts
                |> moveCartsRecursively state.track (SafeMovement [])
    in
    case movementResult of
        Crash crash ->
            crash

        SafeMovement newCarts ->
            findFirstCrash
                { state | carts = newCarts }


compareCarts a b =
    case compare a.y b.y of
        LT ->
            LT

        GT ->
            GT

        EQ ->
            compare a.x b.x


type CartMovementResult
    = Crash ( Int, Int )
    | SafeMovement (List Cart)


moveCartsRecursively : Track -> CartMovementResult -> List Cart -> CartMovementResult
moveCartsRecursively track movementResult cartsToGo =
    case movementResult of
        Crash crash ->
            Crash crash

        SafeMovement cartsSoFar ->
            case cartsToGo of
                [] ->
                    SafeMovement cartsSoFar

                cart :: otherCartsToGo ->
                    let
                        newCart =
                            incrementCart track cart

                        newCartCoords =
                            cartToCoords newCart
                    in
                    case (cartsSoFar ++ otherCartsToGo) |> List.map cartToCoords |> List.member newCartCoords of
                        True ->
                            Crash newCartCoords

                        False ->
                            moveCartsRecursively track
                                (SafeMovement (newCart :: cartsSoFar))
                                otherCartsToGo


cartToCoords cart =
    ( cart.x, cart.y )


incrementCart track cart =
    let
        ( nextX, nextY ) =
            case cart.facing of
                Up ->
                    ( cart.x, cart.y - 1 )

                Down ->
                    ( cart.x, cart.y + 1 )

                Right ->
                    ( cart.x + 1, cart.y )

                Left ->
                    ( cart.x - 1, cart.y )

        nextTrackSegment =
            getTrackSegment nextX nextY track

        nextFacing =
            case ( nextTrackSegment, cart.facing, cart.nextDecision ) of
                ( EmptySpace, _, _ ) ->
                    Debug.todo "broken track ran into blank space"

                ( Straight, _, _ ) ->
                    cart.facing

                ( CornerDownLeftToUpRight, Up, _ ) ->
                    Right

                ( CornerDownLeftToUpRight, Down, _ ) ->
                    Left

                ( CornerDownLeftToUpRight, Right, _ ) ->
                    Up

                ( CornerDownLeftToUpRight, Left, _ ) ->
                    Down

                ( CornerUpLeftToDownRight, Up, _ ) ->
                    Left

                ( CornerUpLeftToDownRight, Down, _ ) ->
                    Right

                ( CornerUpLeftToDownRight, Right, _ ) ->
                    Down

                ( CornerUpLeftToDownRight, Left, _ ) ->
                    Up

                ( Intersection, Up, LeftNext ) ->
                    Left

                ( Intersection, Up, StraightNext ) ->
                    Up

                ( Intersection, Up, RightNext ) ->
                    Right

                ( Intersection, Down, LeftNext ) ->
                    Right

                ( Intersection, Down, StraightNext ) ->
                    Down

                ( Intersection, Down, RightNext ) ->
                    Left

                ( Intersection, Right, LeftNext ) ->
                    Up

                ( Intersection, Right, StraightNext ) ->
                    Right

                ( Intersection, Right, RightNext ) ->
                    Down

                ( Intersection, Left, LeftNext ) ->
                    Down

                ( Intersection, Left, StraightNext ) ->
                    Left

                ( Intersection, Left, RightNext ) ->
                    Up

        nextDecision =
            case ( nextTrackSegment, cart.nextDecision ) of
                ( Intersection, LeftNext ) ->
                    StraightNext

                ( Intersection, StraightNext ) ->
                    RightNext

                ( Intersection, RightNext ) ->
                    LeftNext

                _ ->
                    cart.nextDecision
    in
    { x = nextX
    , y = nextY
    , facing = nextFacing
    , nextDecision = nextDecision
    }


getTrackSegment x y track =
    Array.get y track
        |> Maybe.andThen (Array.get x)
        |> Maybe.withDefault EmptySpace


part1 text =
    text |> parseState |> findFirstCrash


part2 text =
    text |> parseState |> findLastCart


findLastCart state =
    let
        movementResult =
            state.carts
                |> List.sortWith compareCarts
                |> moveCartsSafelyRecursively state.track []
    in
    case movementResult of
        [] ->
            Debug.todo "ran out of carts"

        cart :: [] ->
            cartToCoords cart

        newCarts ->
            findLastCart
                { state | carts = newCarts }


moveCartsSafelyRecursively : Track -> List Cart -> List Cart -> List Cart
moveCartsSafelyRecursively track cartsSoFar cartsToGo =
    case cartsToGo of
        [] ->
            cartsSoFar

        cart :: otherCartsToGo ->
            let
                newCart =
                    incrementCart track cart

                newCartCoords =
                    cartToCoords newCart

                removeCrash =
                    List.map (\c -> ( c, cartToCoords c ))
                        >> List.filter (\( c, coords ) -> coords /= newCartCoords)
                        >> List.map Tuple.first
            in
            case (cartsSoFar ++ otherCartsToGo) |> List.map cartToCoords |> List.member newCartCoords of
                True ->
                    moveCartsSafelyRecursively track (removeCrash cartsSoFar) (removeCrash otherCartsToGo)

                False ->
                    moveCartsSafelyRecursively track (newCart :: cartsSoFar) otherCartsToGo


exampleText =
    """/->-}        
|   |  /----}
| /-+--+-}  |
| | |  | v  |
}-+-/  }-+--/
  }------/   """


exampleText2 =
    """/>-<}  
|   |  
| /<+-}
| | | v
}>+</ |
  |   ^
  }<->/"""


inputText =
    """                                             /---------------------------------------------------------------------------------------------}          
 /----------------------<--------------------+----------------------------}                                                                |          
 |                                           |                            |                                                                |          
 |  /------------------}                     |                            |                              /--------------}                  |          
 |  |                  |                     |                            |                              |              |                  |          
 |  |                  |                     |       /--------------------+------------------------------+--------------+-------}          |          
 |  |                  |                     |       |      /-------------+------------------------------+--------------+-------+----------+-----}    
 |  |                  |                     |       |     /+-------------+-----------------}            | /------------+-------+--------} |     |    
 |  |                  |                     |       |     ||             |                 |            | |            |       |        | |     |    
 |  |         /--------+---------------------+-------+-----++-------------+-------<---------+------------+-+--------}   |       |        | |     |    
 |  |         |   /----+---------------------+-------+-----++-------------+-----------------+------------+-+-----}  |   |       |        | |     |    
 |  |         |   |    |            /--------+-------+-----++-------------+------------}    |     /------+-+-}   |  |   |       |        | |     |    
 |  |         | /-+----+------------+--------+-------+-----++-------------+------------+----+-----+-}    | | |   |  |   |       |     /--+-+-----+---}
 |  |    /----+-+-+----+------------+--------+-------+-----++---}         |            |    | /---+-+----+-+-+---+--+---+-------+-----+--+}|     |   |
 |  |    |    | |/+----+------------+--------+-------+-----++---+---------+------------+----+-+---+}|    | | |   |  |   |       |  /--+--+++--}  |   |
 |  |   /+----+-+++----+------------+--------+-------+-----++---+---}     |            |    | |   |||    | | |   |  |   |       |  |  |  |||  |  |   |
 |  |   ||    | |||    |         /--+--------+}      |     ||   |  /+-----+------------+---}| |   |||    | | |   |  |   |       |  |  |  |||  |  |   |
 |  |   ||    | |||    |         |  |        ||   /--+-----++---+--++-----+------------+---++-+---+++----+-+-+---+--+---+-------+--+--+--+++--+--+}  |
 |  |   ||    | ||| /--+---------+--+-}/-----++-} | /+-----++---+} ||     |            |   || |   |||    | | |   |  |   | /-----+--+--+--+++} |  ||  |
 |  |   ||    | ||| |  |         |  | ||     || | | ||     ||   || ||     |            |   || |   |||    | | |   |  |   | ^     |  |  |  |||| |  ||  |
 |  |   ||    | ||| |  |    /----+--+-++-----++-+-+-++-----++---++-++-}   |            |   || |   |||    | | |   |  |   | |     |  |  |  |||| |  ||  |
 |  |   ||    | ||}-+--+----+----+--+-++-----++-+-+-++-----++---++-++-+---+------------+---++-+---+++----+-+-+---/  |   | |     |  |  |  |||| |  ||  |
 |  | /-++----+-++--+--+----+-->-+--+-++-----++-+-+-++-----++>--++-++-+---+------------+---++}|   |||    | | |      |   | |     |  |  |  |||| |  ||  |
 |  | | ||    | ||  |  |    |    |  | ||     || | | ||     ||   || || |   |            |   ||||   |||    | | |      |   | |     |  |  |  |||| |  ||  |
 |  | | ||    | ||  |  |    |    |  }-++-----++-+-+-++-----++---++-++-+---+------------/   ||||   |||   /+-+-+------+---+-+-----+-}|  |  |||| |  ||  |
/+--+-+-++----+-++--+--+----+----+----++-----++}| | ||     ||   || || |   |                ||||   |||/--++-+-+--}   |   | |     | ||  |  |||| |  ||  |
||  | | ||    | ||  |  |    | /--+----++-----++++-+-++-----++---++-++-+---+----------------++++}  ||||  || | |  |   |   | |     | ||  |  |||| |  ||  |
||  | | }+----+-++--+--+----+-+--+----++-----++++-+-++-----++---++-+/ |   |                |||}+--++++--++-+-+--+---+---+-+-----+-++--+--+/|| |  ||  |
||  | |  }----+-++--+--+----+-+--+----++-----++++-+-++-----++---/| |  |   |                ||| |  ||||  || | |  |   |  /+-+-----+-++--+--+-++-+-}||  |
||  | |       | ||  |  |   /+-+--+---}||     |||| }-++-----++----+-+--+---+----------------+++-+--++++--++-+-+--+---+--++-+-----+-++--+--+-++-+-++/  |
||  | |       | ||  |  |   || |  |   |||     ||||   ||    /++----+-+} |   |                ||| |  ||||  || | |  |   |  || |     | ||  |  | || | ||   |
||  | |       | ||  |  |/--++-+--+---+++-----++++---++----+++----+-++-+---+-------}        ||| |  ||||  || | |  |   |  || }-----+-++--+--+-+/ | ||   |
||  | |       | ||  |  ||  || |  |   |||     ||||   ||  /-+++----+-++-+---+-------+--------+++}|  ||||  || | |  |   |  ||       | ||  |  | |  | ||   |
||  | |       | ||  |  ||  || |  |   |||     ||||   ||  | |||    | || |   |       |        ||||| /++++--++-+-+--+---+--++------}| ||  |  | |  | ||   |
||  | |       | ||  |  ||  || |  |   |||     ||||   ||/-+-+++----+-++-+---+-------+--------+++++}|||||  || | |  |   |  ||      || ||  |  | |  | ||   |
||  | |       | ||  | /++--++-+--+---+++-----++++---+++-+-+++----+-++-+-} |       |   /----+++++++++++--++-+-+--+---+--++------++-++--+--+-+--+-++}  |
||  | |       | ||  | |||  || |  |   |||     ||||   ||| | |||    | || | | |       |/--+----+++++++++++--++-+-+--+-} |  ||      || ||  |  | |  | |||  |
|}--+-+-------+-++--+-+++>-++-+--+---+++-----++++---+++-+-+++----+-++-+-+-/ /-----++--+----+++++++++++--++-+-+--+-+-+--++------++-++--+--+-+--+}|||  |
|   | |       | ||  | |||  || | /+---+++-----++++---+++}|/+++----+-++-+-+---+-----++--+----+++++++++++--++-+-+--+-+-+--++-}    || ||  |  | |  |||||  |
|  /+-+-------+-++--+}|||  |v | ||   |||     ||||   ||||||}++----+-+/ | |   |     ||  |    |||||||||||  || | |  | | |  || |    || ||  |  | |  |||||  |
|  || |       | ||  |||||  || | ||   |||/----++++---++++++-++----+-+--+-+---+-----++--+----+++++++++++--++-+-+} | | |  || |    || ||  |  | |  |||||  |
|  || |       | ||  |||||  || | ||   ||||    ||||   |||||| ||    | |  | |   |  /--++--+----+++++++++++--++-+-++-+-+-+--++-+----++-++--+--+-+} |||||  |
| /++-+-------+-++--+++++--++-+-++---++++----++++---++++++-++----+-+--+-+---+--+--++--+----+++++++++++--++-+}|| | | |  || |    || ||  |  | || |||||  |
|/+++-+-------+-++--+++++--++-+-++---++++----++++---++++++-++}   | |  | |   |  |  ||  |    |||||||||||  || |||| | | |  || |    || ||/-+--+-++-+++++-}|
||||| |       | ||  |||||  || | ||   ||||    ||||   |||||| |||   | |  | |   |  |  ||  |    |||||||||||  || |||| | | |  ||/+----++-+++-+--+}|| ||||| ||
||||| |       | ||  |||||  || | ||   ||||/---++++---++++++-+++}  | |  | |   |  |  ||  |    |||||||||||  || |||| | | |  ||||    || ||| |  |||| ||||| ||
||||| |       | ||  |||||  || | ||   |||||   ||||   |||||| ||||  | |  | | /-+--+-<++--+----+++++++++++--++-++++-+-+-+--++++----++-+++-+--++++-+++++}||
||||| |       | ||  |||||  || | |}---+++++---+/||   |||||| ||||  | |  | |/+-+--+--++--+----+++++++++++--++-++++}| | |  ||||    || ||| |  |||| ||||||||
||||| |     /-+-++--+++++--++-+-+----+++++---+-++-} |||||| ||||/-+-+--+-+++-+--+--++--+----+++++++++++} || |||||| | |  ||||    || ||| |  |||| ||||||||
||||| |     | |/++--+++++--++-+-+----+++++---+-++-+-++++++-+++++-+-+--+-+++-+--+--++-}|    |||||||||||| || |||||| | |  ||||    || ||| |  |||| ||||||||
||||| |     | ||||  |||||  || | |    |||||   | || | |||||}-+++++-+-+--+-+++-+--+--++-++----++++++++++++-++-++++++-+-+--+++/    || ||| |  |||| ||||||||
||||| |     | ||||  |||||  || | |    ||||| /-+-++-+-+++++--+++++-+-+--+-+++-+--+--++-++----++++++++++++-++-++++++}| |  |||     || |}+-+--++++-/|||||||
||||| |     | ||||  |||||  || | |    ||||| | | || | ||||| /+++++-+-+--+-+++-+--+--++-++----++++++++++++}|| |||||||| |  |||     || | | |  ||||  |||||||
||||| |     | ||||  ||||| /++-+-+----+++++-+-+-++-+-+++++-++++++-+-+--+-+++-+--+--++-++----+++++++++++++++-++++++++-+} |||     || | | |  ||||  |||||||
||||| |     | ||||  ||||| ||| | |  /-+++++-+-+-++-+-+++++-++++++-+-+--+-+++-+--+--++}||    |||||||}+++++++-++/||||| || |||  /--++-+-+-+--++++} |||||||
||||| |     | ||||  }++++-+++-+-+--+-+/||| | | || | ||||| |||||| | |  | ||}-+--+--+++++----+++++++-+++++++-++-+++++-++-+++--+--++-+-+-+--+++++-++++/||
||||| |     | ||||   |||| ||| | |  | | ||| | | || | }++++-++++++-/ |  | ||  |  |  ||||}----+++++++-+++++++-++-+++++-++-+++--+--++-+-+-+--+++++-+++/ ||
||||| |     | ||||   |||| ||| | |  | | ||| | | || |  |||| ||||||   |  | ||  |  |  ||||     ||||||| ||||||| || ||||| || |||  |  || | | |  ||||| |||  ||
||||| |     | ||||   |||| ||| | |  | | ||| | | || |  |||| ||||||   |  | ||  |  |  ||||     ||||||}-+++++++-++-+++++-++-+++--+--/| | | v  ||||| |||  ||
||||| |     | ||||   |||| ||| |/+--+-+-+++-+-+-++-+--++++-++++++---+-}| ||  |  |  ||||     ||||||  ||||||| || ||||| || |||  |   | | | |  ||||| |||  ||
||||| |     | ||||   |||| ||| |||  | | ||| | | || |  }+++-++++++---+-++-++--+--+--++++-----++++++--+++++++-++-+++++-++-+++--+---/ | | |  ||||| |||  ||
||||| |     | ||||   |||| ||| |||  | | ||| | | || |   ||| ||||||   | || ||  |  |  ||||     ||||||  ||||||| || ||||| || |||  |     | | |  ||||| |||  ||
}++++-+-----+-++++---++++-+++-+++--+-+-+++-+-+-/|/+---+++-++++++---+-++-++--+--+} ||||     ||||||  ||||||| }+-+++++-++-+++--+-----+-+-+--/|||| |||  ||
 |||| |     | |||| /-++++-+++-+++--+-+-+++-+-+--+++---+++-++++++---+-++-++} |  || ||||     ||||||  |||||||  | ||||| || |||  |     | | |   |||| |||  ||
 |||| |   /-+-++++-+-++++-+++-+++--+-+-+++-+-+--+++---+++-++++++---+-++-+++-+--++-++++-----++++++--+++++++--+-+++++}|| |||  |     | | |   |||| |||  ||
 |||| |   | | |||| | |||| ||| |||  | | ||| | |  |||   ||| ||||||   | ||/+++-+--++-++++-----++++++--+++++++--+-++++++++-+++--+-----+-+-+---++++-+++} ||
 |||| |   | | |||| | |||| ||| |||  | | ||| | |  |||   ||| ||||||   }-++++++-+--++-++++-----/|||||  |||||||  | |||||||| |||  |     | | |   |||| |||| ||
 }+++-+---+-+-++++-+-++++-+++-+++--+-+-+++-+-+--+++---+++-+++/|}-----++++++-+--++-++++------+++++--+++/|||  | |||||||| |||  |     | | |   |||| |||| ||
  ||| |   | | |||| |/++++-+++-+++-}| | ||| | |  |||   ||| ||| |      |||||| |  || ||||     /+++++--+++-+++--+-++++++++-+++--+-----+-+-+--}|||| |||| ||
  ||| |   | | |||| |||||| ||| ||| || | ||| | |  |||   ||| ||| |      |||||| | /++-++++-----++++++--+++-+++--+-++++++++-+++-}|     | | }--+++++-++++-+/
  ||| |   | | |||| |||||| ||| ||| || | ||| | |  |||   ||| ||| |      |||||| | ||| ||||     ||||||  ||| |||  | |||||||| ||| ||     | |    ||||| |||| | 
  ||| |   | | |||| |||||| |||/+++-++-+-+++-+-+--+++---+++-+++-+------++++++-+-+++-++++-----++++++--+++-+++--+-++++++++-+++}||     | |    ||||| |||| | 
 /+++-+---+-+-++++-++++++-+++++++-++-+-+++-+-+--+++---+++-+++-+------++++++-+-+++}||||     ||||||  ||| |||  | |||||||| ||||||     | }----+++++-++++-/ 
 |||| |   | | |||| |||||| ||||||| || | ||| | |  |||   ||| ||| |      |||||| | ||||||||     ||||||  ||| |}+--+-++++++++-++++++-----/      ||||| ||||   
 |||| |   | | |||| |||||| ||||||| || | ||| | |  |||   ||| ||| |      ||}+++-+-++++++++-----++++++--+++-+-+--+-++++++++-++++++------------+++++-+++/   
 |||}-+---+-+-++++-++++/| ||||||| || | ||| | |  |||   ||| ||| |      || ||| | ||||||||   /-++++++-}||| | |  | |||||||| ||||||            ||||| |||    
 |||  |   | | |||| ||||/+-+++++++-++-+-+++-+-+--+++---+++-+++-+------++-+++-+-++++++++---+-++++++-++++-+-+--+-++++++++-++++++-----}      ||||| |||    
 |||  |   | | |||| |||||| ||||||| || | ||| | |  |||   ||| ||| |      || ||| | ||||||||   | |||||| |||| | |  | |||||||| ||||||     |  /---+++++-+++-}  
 |||  |   | | |||| |}++++-+++++++-/| |/+++-+-+--+++---+++-+++-+------++-+++-+-++++++++---+-++++++-++++-+-+--+-++++++++-++++++-}   |  |   ||||| ||| |  
 |||  |   | | |||| | |||| |||||||  | |||||/+-+--+++---+++-+++-+----} || |}+-+-++++++++---+-++++++-++++-+-+--+-+/|||||| |||||| |   |  |   ||||| ||| |  
 |||  |   | | |||| | |||| ||||}++--+-+++++++-+--+++---+++-+++-+----+-++-+-+-+-++++++++---+-++++/| |||| | |  | | |||||| |||||| |   |  |   ||||| ||| |  
 |||  |   | | |||| | |||| |||| ||  | ||||||| |  |||   ||| ||| |    | || | | | ||||||||   | |||| | |||| | |  | | |||||| |||||| |   |  |   ||||| ||| |  
 |||  |   | | |||| | |||| |||| ||  | ||||||| |  |||   ||| ||| |    | || | | | ||||||||   | |||| | |||| | |  | | |||||| |||||| |   |  |   ||||| ||| |  
 |||  |   | | |||| | ||||/++++-++--+-+++++++-+--+++---+++-+++-+----+-++-+-+-+-++++++++---+>++++-+-++++-+-+--+-+}|||||| |||||| |   |  |   ||||| ||| |  
 |||  |   | | |||| | ||||||||| ||  | ||||||}-+--+++---+++-+++-+----+-++-+-+-+-++++++++---+-++++-+-++++-+-+--+-+++/|||| |||||| |   |  |   ||||| ||| |  
 |||  |/--+-+-++++-+-+++++++++-++--+-++++++--+--+++---+++-+++-+----+-++-+-+-+-++++++++---+-++++-+-++++-+-+} | ||| |||| |||||| |   |  |   ||||| ||| |  
 |||  ||  | | |||| | ||||||||| ||  | ||}+++--+--/||   ||| ||| |    | || | | | ||||||||   | |||| | |||| | || | ||| |||| |||||| |   |  |   ||||| ||| |  
 |||  ||  | | |||| | ||||||||| ||  | || |||  |   ||   ||| ||| |    | || | | | ||||||||   | |||| | |||| | || | ||| |||| |||||| |   |  |   ||||| ||| |  
 }++--++--+-+-++++-+-+++++++++-++--+-++-+++--+---++---+++-+++-+----+-++-+-+-+-+++/||||   | |||| | |||| | || | ||| |||| |||||| |   |  |   ||||| ||| |  
  ||  ||  | | |||| | ||||||||| ||  | || |||  | /-++---+++-+++-+----+-++-+-+-+-+++-++++---+-++++-+}|||| | || | ||| |||| |||||| |   |  |   ||||| ||| |  
  ||  ||  |/+-++++-+-+++++++++-++--+-++}|||  | | ||   ||| ||| |    | || | | | ||| ||||   | |||| |||||| |/++-+-+++-++++-++++++}|   |  |   ||||| ||| |  
  ||  ||  |||/++++-+-+++++++++}||  | ||||||  | | ||   ||| ||| |    | || | | | |}+-++++---+-++++-++++++-++++-+-+++-++++-++++++++---+--+---+++/| ||| ^  
  |}--++--++++++++-+-/|||||||||||  | ||||||  | | ||   ||| ||| |    | || | | | }-+-++++---+-++++-++++++-++++-+-+++-++++-++++/|||   |  |   ||| | ||| |  
  |   ||  |||||||| |  |||||||||||  | ||||||  | | ||   ||| |}+-+----+-++-+-+-+---+-++++---+-+/|| |||||| |||| | ||| |||| |||| |||   |  }---+++-+-+++-/  
  |   ||  |||||||| |  |||||||||||/-+-++++++--+-+-++---+++-+-+-+----+-++-+-+-+---+-++++---+-+-++-++++++-++++-+-+++-++++-++++-+++--}|      ||| | |||    
  |   }+--++++++++-+--++++++++++++-+-++++++--+-+-++---+++-+-+-+----+-++-+-+-+---+-++++---+-+-/| |||||| |||| | ||| |||| |||| |||  ||      ||| | |||    
  |    |  |||||}++-+--++++++++++++-+-++++++--+-+-++---+++-+-+-+----+-++-+-+-+---+-+++/   | |  | |||||| |||| | ||| |||| |||| |||  ||      ||| | |||    
  |    }--+++++-++-+--++++++++++++-+-++++++--+-+-++---+++-+-+-+----+-++-+-+-+---+-+++----+-+--+-++++++-+++/ | ||| |||| |||| |||  ||      ||| | |||    
/-+-------+++++}|| |  |||||||||||| | ||||||  }-+-++---+++-+-+-+----+-++-+-+-+---+-+++----+-+--+-++++++-+++--+-+++-++++-++++-+++--++------++/ | |||    
| |       ||||}+++-+--++++++++++++-+-++++++----+-++---+++-+-+-+----+-++-+-+-+---+-+++----+-+--+-++++++-+++--+-+++-++/| |||| |||  ||      ||  | |||    
| |       |||| ||| |  |||||||||||| | ||||||    | ||   ||| | }-+----+-++-+-+-+---+-+++----+-+--+-++++++-+++--+-+++-++-+-++++-+++--++------++--+-++/    
| |       |||| ||| |  |||||||||||| | ||||||    | ||   ||| |   |    | || | | }---+-+++----+-+--+-++++++-+++--+-+++-++-+-++++-+++--++------++--+-/|     
| |       |||| ||| |  ||||||||||}+-+-++++++----+-++---+/|/+---+----+}|| | |     | |||    | |  | |||||| ||}--+-+++-++-+-+/|| |||  ||      ||  |  |     
| |       |||| ||| |  |||||||^|}-+-+-++++++----+-++---+-+++---+----++/| | |     | |||    | |  | |||||| ||  /+-+++-++-+-+-++-+++--++----} ||  |  |     
| |       |||| ||| |  ||||||}++--+-+-++++++----+-++---+-+++---+----++-/ | |     | |||    | |  | |||||| ||  || ||| || | | || |||  ||    | ||  |  |     
| |       |||| ||| |  |||||| ||  | | ||||||    | ||   | |||   |    ||   | |     | |||    | |  | |||||}-++--++-++/ || | }-++-+++--++----+-++--+--/     
| |       |||| ||| |  ||}+++-++--+-+-++++++----+-++---+-+++---+----++---+-+-----+-/|| /--+-+--+-+++++--++--++-++--++-+---++-+++--++---}| ||  |        
| |       ||}+-+++-+--++-+++-++--+-+-++++++----+-+/   | |||   |    ||   | |     |  || |  | |  | |||||  ||  || ||  || |   || |||  ||   || ||  |        
| |       || | ||| |  || ||| ||  }-+-++++++----+-+----+-+++---+----++---+-+-----+--++-+--+-+--+-+++++--++--++-++--++-+---++-+++--/|   || ||  |        
| |       || | ||| |  || ||| ||    | ||||||    | |    |/+++---+----++---+-+-----+--++-+--+-+--+-+++++--++--++-++--++-+---++-+++---+---++-++--+-----}  
| |       || | ||| |  || ||| ||    | |||}++----+-+----+++++---+----++---+-+-----+--++-+--+-+--+-+++++--++--++-/|  || |   || |||   |   || ||  |     |  
| |       || | |||/+--++-+++-++----+-+++-++----+-+----+++++---+----++---+-+-----+--++-+--+-+--+-+++++--++--++} |  || |   || |||   |   || ||  |     |  
| |       || | |||||  || }++-++----+-+++-++----+-+----+++++---+----++---+-+-----+--++-+--+-+--+-+++++--++--+++-/  || |   || |||   |   || ||  |     |  
| |       || | ||||}--++--++-++----+-+++-++----+-+----+++++---+----++---+-/     |  || |  | |  | |||||  ||  |||    || |   || |||   |   || ||  |     |  
| |       |}-+-++++---++--++-++----+-++/ ||    | }----+++++---+----++---+-------/  || |  | |  | |||||  ||  |||    || |   || }++---+---++-++--/     |  
|/+-------+--+-++++---++--++-++----+-++--++}   |      |||||   |    ||   |          || |  | }--+-+++++--++--+++----++-+---++--++---+---++-/|        |  
|||       |  | ||||   ||  || ||    | ||  |||   |      ||}++---+----++---+--->------++-+--+----/ |||||  ||  |||    || |   }+--++---+---++--/        |  
|||       |  | |}++---++--++-++----+-++--+++---+------++-++---+----++---+----------++-+--+------++++/  ||  |||    || |    |  ||   |   ||           |  
|||       |  | | ||   ||  || ||/---+-++--+++---+---}  || }+---+----+/   |  /-------++}|  |      ||||   ||  }++----++-+----+--++---+---+/           |  
|||       |  | | }+---++--++-+++---+-++--+++---+---+--++--+---+----+----+--+-------++++--+------+++/   ||   ||    || |    |  ||   |   |            |  
|||/------+--+-+--+---++--++-+++---+-++--+++---+---+--++--+---+--} |    |  |       |||}--+------+++----++---++----++-+----+--++---+---/            |  
||||      |/-+-+--+---++--++-+++---+-++--+++---+---+--++--+---+--+-+----+--+}      }++---+------+++----++---++----/| |    |  ||   |                |  
||||      || | |  |   ||  || |||   | ||  |||   |   |  ||  |   |  | |    |  ||/------++---+------+++----++---++-----+-+----+--++---+-----}          |  
||||      || | |  |  /++--++-+++---+-++--+++---+---+--++--+---+--+-+----+--+++------++---+------+++<---++---++-----+-+----+--++-} |     |          |  
||||      ||/+-+--+--+++--++-+++}  | ||  |||   |   |  ||  |   |  | |    |  |||      ||   |      |||/---++---++-----+-+---}|  || | |     |          |  
||||      |||| |  |  |||  }+-++++--+-++--+++---+---+--++--+---+--+-+----+--+++------++---+------++++---++---++-----+-/   ||  || | |     |          |  
||||      |||| |  |  |||   | ||||  | ||  |||   |   |  ||  |   |  | |    |  |||      ||   |      ||||   ||   ||     |     ||  || | |     |          |  
||||      |||| |  |  |||   | ||||  | ||  |||   |   |  ||  |   |  | |    |  }++------+/   |      ||||   ||   ||     |     ||  || | |     |          |  
}+++------++++-/  |  |||   | ||||  | ||  |}+---+---+--++--+---+--+-/    |   ||      |    |      ||||   ||   ||     |     ||  || | |     |          |  
 |||      ||||    |  |}+---+-++++--+-++--+-+---+---+--++--+---+--+------/   ||      |   /+------++++---++---++-----+-----++--++-+-+-----+------}   |  
 |||      ||||    |  | |   | ||||  | |}--+-+---+---+--++--+---+--+----------++------+---++------++++---++---++-----+-----++--+/ | |     |      |   |  
 |}+------++++----+--+-+---+-++++--+-+---+-+---+---+--++--+---+--+----------++------+---++------++++---++---/|     |     ||  |  | |     |      |   |  
 | |      ||||    |  | |   }-++++--+-/   | |   |   |  ||  }---+--+----------++------+---++------++++---/|    |     |     ||  |  | |     |      |   |  
 | |      ||||    |  | |     ||||  |     | |   |   |  ||      |  |          ||      |   ||      ||||    |    |     |     ||  |  | |     |      |   |  
 | |      ||||    |  }-+-----++++--+-----+-+---+---+--++------+--+----------++------+---++------++++----+----+-----+-----++--+--/ |     |      |   |  
 | |      ||||    |    |     ||||  |     | |   }---+--++------+--+----------++->----+---++------+/||    |    |     |     ||  |    |     |      |   |  
 | |      ||||    |    }-----++++--+-----+-+-------+--++------+--+----------++------+---++------+-++----+----+-----+-----++--+----/     |      |   |  
 | |      ||||    }----------++++--+-----+-+-------+--++------+--+----------++------+---++------+-++----+----/     |     ||  |          |      |   |  
 | |      ||||               ||||  |     }-+-------+--++------/  |          |}------+---++------+-++----+----------+-----++--+----------/      |   |  
 | |      ||||               ||}+--+-------+-------/  }+---------+----------+-------+---++->----/ ||    |          |     ||  |                 |   |  
 | |      |||}---------------+/ |  |       |           |         |          |       |   ||        ||    |          |     ||  |                 |   |  
 | |      ||}----------------+--/  }-------+-----------+---------+----------+-------/   ||        ||    |          |     ||  |                 |   |  
 | }------++-----------------+-------------+-----------+---------/          |           ||        ||    |          |     ||  |                 |   |  
 |        ||                 |             |           |                    |           |}--------/}----+----------+-----/|  |                 |   |  
 |        }+-----------------+-------------+-----------+--------------------+-----------+---------------+----------/      |  |                 |   |  
 }-<-------+-----------------+-------------/           |                    |           }---------------+-----------------+--+-----------------/   |  
           }-----------------+-------------------------+--------------------/                           |                 |  |                     |  
                             }-------------------------+------------------------------------------------+-----------------/  |                     |  
                                                       |                                                }--------------------/                     |  
                                                       }-------------------------------------------------------------------------------------------/  
"""
